<!--
  #%L
  Wisdom-Framework
  %%
  Copyright (C) 2013 - 2014 Wisdom Framework
  %%
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
  #L%
  -->
<!DOCTYPE html>
<html>
<head lang="en">

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="description" content="Wisdom Framework Monitoring"/>
    <meta name="author" content="The Wisdom Framework Team"/>

    <script src="/libs/jquery.min.js"></script>
    <script src="/libs/js/bootstrap.min.js"></script>


    <title>Wisdom - Monitoring  </title>


    <link rel="stylesheet" href="/libs/css/bootstrap.css" media="screen"/>
    <link href="/assets/dashboard.css" rel="stylesheet"/>

</head>
<body>
<!-- Inset the top bar -->
<div th:replace="layout :: topbar"></div>

<div class="container-fluid">
    <div class="row">
        <div th:replace="layout :: sidebar"></div>
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
            <!-- the actual content goes there -->
            <h1 class="page-header">Dashboard</h1>

            <div class="container">
                <div class="row">
                    <div class="col-md-4">
                        <b>Memory &amp; CPU</b>

                        <p>Total Memory <span id="memoryTotalUsed">-1</span> M / <span id="memoryTotalMax">-1</span> M.
                        </p>

                        <div class="progress progress-success">
                            <div id="memory" class="progress-bar" role="progressbar" aria-valuemin="0"
                                 aria-valuemax="100">
                                <!-- will be written by the script -->
                            </div>
                        </div>

                        <p>Heap Memory <span id="heapTotalUsed">-1</span> M / <span id="heapTotalMax">-1</span> M.</p>

                        <div class="progress progress-success">
                            <div id="heap" class="progress-bar" role="progressbar" aria-valuemin="0"
                                 aria-valuemax="100">
                                <!-- will be written by the script -->
                            </div>
                        </div>

                        <p>System CPU Load</p>

                        <div class="progress progress-success">
                            <div id="systemLoad" class="progress-bar" role="progressbar" aria-valuemin="0"
                                 aria-valuemax="100">
                                <!-- will be written by the script -->
                            </div>
                        </div>

                        <p>Process CPU Load</p>

                        <div class="progress progress-success">
                            <div id="processLoad" class="progress-bar" role="progressbar" aria-valuemin="0"
                                 aria-valuemax="100">
                                <!-- will be written by the script -->
                            </div>
                        </div>

                        <button id="thread-dump" type="button" class="btn btn-primary">Thread Dump</button>

                        <!--<p>Non-Heap Memory <span id="nonheapTotalUsed">0</span> M / <span id="nonheapTotalMax">0</span> M.</p>-->

                        <!--<div class="progress progress-success">-->
                        <!--<div id="nonheap" class="progress-bar" role="progressbar" aria-valuemin="0"-->
                        <!--aria-valuemax="100">-->
                        <!--&lt;!&ndash; will be written by the script &ndash;&gt;-->
                        <!--</div>-->
                        <!--</div>-->
                    </div>
                    <div class="col-md-4">
                        <b>Threads</b> (Total: <span id="threadsCount">-1</span>)
                        <p>Runnable <span id="runnableCount">-1</span></p>

                        <div class="progress progress-success">
                            <div id="threads" class="progress-bar" role="progressbar" aria-valuemin="0"
                                 aria-valuemax="100">
                                <!-- will be written by the script -->
                            </div>
                        </div>

                        <p>Timed waiting (<span id="timeWaiting">-1</span>)</p>

                        <div class="progress progress-success">
                            <div id="wait" class="progress-bar" role="progressbar" aria-valuemin="0"
                                 aria-valuemax="100">
                                <!-- will be written by the script -->
                            </div>
                        </div>

                        <p>Waiting (<span id="waitingCount">-1</span>)</p>

                        <div class="progress progress-success">
                            <div id="waitingRatio" class="progress-bar" role="progressbar" aria-valuemin="0"
                                 aria-valuemax="100">
                                <!-- will be written by the script -->
                            </div>
                        </div>

                        <p>Blocked (<span id="blockedCount">-1</span>)</p>

                        <div class="progress progress-success">
                            <div id="blockedRatio" class="progress-bar" role="progressbar" aria-valuemin="0"
                                 aria-valuemax="100">
                                <!-- will be written by the script -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <b>Garbage collections</b>

                        <div class="row">
                            <div class="col-md-6">Mark Sweep count</div>
                            <div class="col-md-4"><span id="MarkSweep"></span></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">Mark Sweep time</div>
                            <div class="col-md-4"><span id="MarkSweepTime"></span> ms</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">Scavenge count</div>
                            <div class="col-md-4"><span id="Scavenge"></span></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">Scavenge time</div>
                            <div class="col-md-4"><span id="ScavengeTime"></span> ms</div>
                        </div>

                        <b>Uptime</b>

                        <div class="row">
                            <div class="col-md-6">Uptime</div>
                            <div class="col-md-4"><span id="Uptime"></span></div>
                        </div>
                    </div>
                </div>
            </div>

            <br/>
            <h1 class="page-header">Health Checks</h1>

            <div class="container-fluid">
                <div class="row" id="health">

                </div>
            </div>

            <div id="waitingDialog" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal"
                                    aria-hidden="true">&times;</button>
                            <h4 class="modal-title">Waiting for data</h4>
                        </div>
                        <div class="modal-body">
                            <p>The application is connecting to the monitoring data source, please wait a
                                second...</p>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="/libs/min/moment.min.js"></script>

<script>
    /*<![CDATA[*/
    /**
     * Creates the health checks element.
     */
    function health(data) {
        var root = $("#health").empty();
        $.each(data.health, function (name, value) {
            console.log("Name " + name + " - " + value);
            var c = $("<div/>").addClass("col-md-2 text-center").text(name);
            if (value) {
                c.addClass("bg-success");
            } else {
                c.addClass("bg-danger");
            }
            root.append(c);
        });
        if (root.children().length == 0) {
            root.append($("<div class=\"text-muted\">No Health Check found.</div>"));
        }
    }

    (function () {
        var Sock = function () {
            var socket;
            if (!window.WebSocket) {
                window.WebSocket = window.MozWebSocket;
            }

            if (window.WebSocket) {
                // Compute the web socket url.
                // window.location.host includes the port
                var url = "ws://" + window.location.host + "/monitor/update";
                socket = new WebSocket(url);
                socket.onopen = onopen;
                socket.onmessage = onmessage;
                socket.onclose = onclose;
            } else {
                alert("Your browser does not support Web Socket.");
            }

            function onopen(event) {
                console.log("Connected to the Monitoring WebSocket")
            }

            function onmessage(event) {
                // Read and update
                process($.parseJSON(event.data));
                $('#waitingDialog').modal('hide');
            }

            function onclose(event) {
                console.log("Disconnected from the Monitoring WebSocket")
            }
        };

        function updateUsedMemory(data) {
            var memoryTotalUsed = data.gauges["jvm.memory.total.used"].value / 1048576;
            $("#memoryTotalUsed").html(Math.round(memoryTotalUsed));

            var memoryTotalMax = data.gauges["jvm.memory.total.max"].value / 1048576;
            $("#memoryTotalMax").html(Math.round(memoryTotalMax));

            drawProgressBar("#memory", memoryTotalUsed * 100 / memoryTotalMax, true);
        }

        function updateHeapMemory(data) {
            var heapUsed = data.gauges["jvm.memory.heap.used"].value / 1048576;
            $("#heapTotalUsed").html(Math.round(heapUsed));

            var heapMax = data.gauges["jvm.memory.heap.max"].value / 1048576;
            $("#heapTotalMax").html(Math.round(heapMax));
            drawProgressBar("#heap", heapUsed * 100 / heapMax, true);
        }

        function updateNonHeapMemory(data) {
            var nonHeapUsed = data.gauges["jvm.memory.non-heap.used"].value / 1048576;
            $("#nonheapTotalUsed").html(Math.round(nonHeapUsed));

            var nonHeapMax = data.gauges["jvm.memory.non-heap.max"].value / 1048576;
            $("#nonheapTotalMax").html(Math.round(nonHeapMax));

            drawProgressBar("#nonheap", nonHeapUsed * 100 / nonHeapMax, true);
        }

        function updateThread(data) {
            var count = data.gauges["jvm.threads.count"].value;
            var runnable = data.gauges["jvm.threads.runnable.count"].value;
            var waiting = data.gauges["jvm.threads.timed_waiting.count"].value;
            var waitingCount = data.gauges["jvm.threads.waiting.count"].value;
            var blockedCount = data.gauges["jvm.threads.blocked.count"].value;

            $("#threadsCount").html(count);
            $("#runnableCount").html(runnable);
            $("#timeWaiting").html(waiting);
            $("#waitingCount").html(waitingCount);
            $("#blockedCount").html(blockedCount);

            drawProgressBar("#threads", (runnable * 100 / count), false);
            drawProgressBar("#wait", (waiting * 100 / count), true);
            drawProgressBar("#waitingRatio", (waitingCount * 100 / count), true);
            drawProgressBar("#blockedRatio", (blockedCount * 100 / count), true);
        }

        function updateGC(data) {
            var marksweep = data.gauges["jvm.garbage.PS-MarkSweep.count"].value;
            var marksweepTime = data.gauges["jvm.garbage.PS-MarkSweep.time"].value;
            var scavenge = data.gauges["jvm.garbage.PS-Scavenge.count"].value;
            var scavengeTime = data.gauges["jvm.garbage.PS-Scavenge.time"].value;

            $("#MarkSweep").html(marksweep);
            $("#MarkSweepTime").html(marksweepTime);
            $("#Scavenge").html(scavenge);
            $("#ScavengeTime").html(scavengeTime);
        }

        function updateCPU(data) {
            var average = data.gauges["jvm.cpu.cpuSystemLoad"].value;
            drawProgressBar("#systemLoad", average, true);

            var cpu = data.gauges["jvm.cpu.cpuProcessLoad"].value;
            drawProgressBar("#processLoad", cpu, true);
        }

        function updateUptime(data) {
            var uptime = data.gauges["jvm.runtime.uptime"].value;
            $("#Uptime").html(moment.duration(uptime).humanize());
        }


        function process(data) {
            updateUsedMemory(data);
            updateHeapMemory(data);
            // Only valid on pre-Java 8 VM
            //updateNonHeapMemory(data);
            updateThread(data);
            updateGC(data);
            updateCPU(data);
            updateUptime(data);

            health(data);
        }

        function drawProgressBar(selector, value, lowIsGood) {
            if (lowIsGood) {
                if (value < 40) {
                    $(selector).attr("style", "width:" + value + "%;").addClass("progress-bar-success")
                            .html(Math.round(value) + " %");
                } else if (value < 90) {
                    $(selector).attr("style", "width:" + value + "%;").addClass("progress-bar-warning")
                            .html(Math.round(value) + " %");
                } else
                    $(selector).attr("style", "width:" + value + "%;").addClass("progress-bar-danger")
                            .html(Math.round(value) + " %");
            } else {
                if (value < 10) {
                    $(selector).attr("style", "width:" + value + "%;").addClass("progress-bar-danger")
                            .html(Math.round(value) + " %");
                } else if (value < 20) {
                    $(selector).attr("style", "width:" + value + "%;").addClass("progress-bar-warning")
                            .html(Math.round(value) + " %");
                } else
                    $(selector).attr("style", "width:" + value + "%;").addClass("progress-bar-success")
                            .html(Math.round(value) + " %");
            }
        }

        $(document).ready(function () {
            setActiveExtension("dashboard");

            $('#waitingDialog').modal({
                show: true,
                keyboard: false
            });

            $.ajax({
                async:false,
                dataType: "json",
                url: "/monitor/dashboard/metrics",
                success: function (data) {
                   process(data);
                   $('#waitingDialog').modal('hide');
                }
            });

            $("#thread-dump").click(function () {
                window.location.href = window.location.href + "thread-dump";
            });
            new Sock();
        }, false);
    })();
    /*]]>*/
</script>

</body>
</html>
