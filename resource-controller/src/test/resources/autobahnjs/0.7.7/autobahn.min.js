"use strict";var AUTOBAHNJS_VERSION="?.?.?";var AUTOBAHNJS_DEBUG=true;var ab=window.ab={};ab._version=AUTOBAHNJS_VERSION;(function(){if(!Array.prototype.indexOf){Array.prototype.indexOf=function(c){if(this===null){throw new TypeError()}var d=new Object(this);var a=d.length>>>0;if(a===0){return -1}var e=0;if(arguments.length>0){e=Number(arguments[1]);if(e!==e){e=0}else{if(e!==0&&e!==Infinity&&e!==-Infinity){e=(e>0||-1)*Math.floor(Math.abs(e))}}}if(e>=a){return -1}var b=e>=0?e:Math.max(a-Math.abs(e),0);for(;b<a;b++){if(b in d&&d[b]===c){return b}}return -1}}if(!Array.prototype.forEach){Array.prototype.forEach=function(g,b){var d,c;if(this===null){throw new TypeError(" this is null or not defined")}var f=new Object(this);var a=f.length>>>0;if({}.toString.call(g)!=="[object Function]"){throw new TypeError(g+" is not a function")}if(b){d=b}c=0;while(c<a){var e;if(c in f){e=f[c];g.call(d,e,c,f)}c++}}}})();ab._sliceUserAgent=function(l,b,g){var h=[];var a=navigator.userAgent;var f=a.indexOf(l);var e=a.indexOf(b,f);if(e<0){e=a.length}var d=a.slice(f,e).split(g);var m=d[1].split(".");for(var c=0;c<m.length;++c){h.push(parseInt(m[c],10))}return{name:d[0],version:h}};ab.getBrowser=function(){var a=navigator.userAgent;if(a.indexOf("Chrome")>-1){return ab._sliceUserAgent("Chrome"," ","/")}else{if(a.indexOf("Safari")>-1){return ab._sliceUserAgent("Safari"," ","/")}else{if(a.indexOf("Firefox")>-1){return ab._sliceUserAgent("Firefox"," ","/")}else{if(a.indexOf("MSIE")>-1){return ab._sliceUserAgent("MSIE",";"," ")}else{return null}}}}};ab.getServerUrl=function(c,e){if(window.location.protocol==="file:"){if(e){return e}else{return"ws://127.0.0.1/ws"}}else{var b=window.location.protocol==="https:"?"wss://":"ws://";var a=window.location.port!==""?":"+window.location.port:"";var d=c?c:"ws";return b+window.location.hostname+a+"/"+d}};ab.browserNotSupportedMessage="Browser does not support WebSockets (RFC6455)";ab.deriveKey=function(b,a){if(a&&a.salt){var d=a.salt;var f=a.keylen||32;var e=a.iterations||10000;var c=CryptoJS.PBKDF2(b,d,{keySize:f/4,iterations:e,hasher:CryptoJS.algo.SHA256});return c.toString(CryptoJS.enc.Base64)}else{return b}};ab._idchars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";ab._idlen=16;ab._subprotocol="wamp";ab._newid=function(){var b="";for(var a=0;a<ab._idlen;a+=1){b+=ab._idchars.charAt(Math.floor(Math.random()*ab._idchars.length))}return b};ab._newidFast=function(){return Math.random().toString(36)};ab.log=function(){if(arguments.length>1){console.group("Log Item");for(var a=0;a<arguments.length;a+=1){console.log(arguments[a])}console.groupEnd()}else{console.log(arguments[0])}};ab._debugrpc=false;ab._debugpubsub=false;ab._debugws=false;ab._debugconnect=false;ab.debug=function(c,a,b){if("console" in window){ab._debugrpc=c;ab._debugpubsub=c;ab._debugws=a;ab._debugconnect=b}else{throw"browser does not support console object"}};ab.version=function(){return ab._version};ab.PrefixMap=function(){var a=this;a._index={};a._rindex={}};ab.PrefixMap.prototype.get=function(b){var a=this;return a._index[b]};ab.PrefixMap.prototype.set=function(c,b){var a=this;a._index[c]=b;a._rindex[b]=c};ab.PrefixMap.prototype.setDefault=function(b){var a=this;a._index[""]=b;a._rindex[b]=""};ab.PrefixMap.prototype.remove=function(c){var a=this;var b=a._index[c];if(b){delete a._index[c];delete a._rindex[b]}};ab.PrefixMap.prototype.resolve=function(c,d){var a=this;var b=c.indexOf(":");if(b>=0){var e=c.substring(0,b);if(a._index[e]){return a._index[e]+c.substring(b+1)}}if(d==true){return c}else{return null}};ab.PrefixMap.prototype.shrink=function(e,d){var a=this;for(var c=e.length;c>0;c-=1){var b=e.substring(0,c);var f=a._rindex[b];if(f){return f+":"+e.substring(c)}}if(d==true){return e}else{return null}};ab._MESSAGE_TYPEID_WELCOME=0;ab._MESSAGE_TYPEID_PREFIX=1;ab._MESSAGE_TYPEID_CALL=2;ab._MESSAGE_TYPEID_CALL_RESULT=3;ab._MESSAGE_TYPEID_CALL_ERROR=4;ab._MESSAGE_TYPEID_SUBSCRIBE=5;ab._MESSAGE_TYPEID_UNSUBSCRIBE=6;ab._MESSAGE_TYPEID_PUBLISH=7;ab._MESSAGE_TYPEID_EVENT=8;ab.CONNECTION_CLOSED=0;ab.CONNECTION_LOST=1;ab.CONNECTION_RETRIES_EXCEEDED=2;ab.CONNECTION_UNREACHABLE=3;ab.CONNECTION_UNSUPPORTED=4;ab.CONNECTION_UNREACHABLE_SCHEDULED_RECONNECT=5;ab.CONNECTION_LOST_SCHEDULED_RECONNECT=6;ab.Deferred=when.defer;ab._construct=function(a,b){if("WebSocket" in window){if(b){return new WebSocket(a,b)}else{return new WebSocket(a)}}else{if("MozWebSocket" in window){if(b){return new MozWebSocket(a,b)}else{return new MozWebSocket(a)}}else{return null}}};ab.Session=function(a,d,e,c){var b=this;b._wsuri=a;b._options=c;b._websocket_onopen=d;b._websocket_onclose=e;b._websocket=null;b._websocket_connected=false;b._session_id=null;b._wamp_version=null;b._server=null;b._calls={};b._subscriptions={};b._prefixes=new ab.PrefixMap();b._txcnt=0;b._rxcnt=0;if(b._options&&b._options.skipSubprotocolAnnounce){b._websocket=ab._construct(b._wsuri)}else{b._websocket=ab._construct(b._wsuri,[ab._subprotocol])}if(!b._websocket){if(e!==undefined){e(ab.CONNECTION_UNSUPPORTED);return}else{throw ab.browserNotSupportedMessage}}b._websocket.onmessage=function(s){if(ab._debugws){b._rxcnt+=1;console.group("WS Receive");console.info(b._wsuri+"  ["+b._session_id+"]");console.log(b._rxcnt);console.log(s.data);console.groupEnd()}var g=JSON.parse(s.data);if(g[1] in b._calls){if(g[0]===ab._MESSAGE_TYPEID_CALL_RESULT){var k=b._calls[g[1]];var f=g[2];if(ab._debugrpc&&k._ab_callobj!==undefined){console.group("WAMP Call",k._ab_callobj[2]);console.timeEnd(k._ab_tid);console.group("Arguments");for(var n=3;n<k._ab_callobj.length;n+=1){var x=k._ab_callobj[n];if(x!==undefined){console.log(x)}else{break}}console.groupEnd();console.group("Result");console.log(f);console.groupEnd();console.groupEnd()}k.resolve(f)}else{if(g[0]===ab._MESSAGE_TYPEID_CALL_ERROR){var u=b._calls[g[1]];var t=g[2];var m=g[3];var w=g[4];if(ab._debugrpc&&u._ab_callobj!==undefined){console.group("WAMP Call",u._ab_callobj[2]);console.timeEnd(u._ab_tid);console.group("Arguments");for(var l=3;l<u._ab_callobj.length;l+=1){var p=u._ab_callobj[l];if(p!==undefined){console.log(p)}else{break}}console.groupEnd();console.group("Error");console.log(t);console.log(m);if(w!==undefined){console.log(w)}console.groupEnd();console.groupEnd()}if(w!==undefined){u.reject({uri:t,desc:m,detail:w})}else{u.reject({uri:t,desc:m})}}}delete b._calls[g[1]]}else{if(g[0]===ab._MESSAGE_TYPEID_EVENT){var v=b._prefixes.resolve(g[1],true);if(v in b._subscriptions){var q=g[1];var h=g[2];if(ab._debugpubsub){console.group("WAMP Event");console.info(b._wsuri+"  ["+b._session_id+"]");console.log(q);console.log(h);console.groupEnd()}b._subscriptions[v].forEach(function(i){i(q,h)})}else{}}else{if(g[0]===ab._MESSAGE_TYPEID_WELCOME){if(b._session_id===null){b._session_id=g[1];b._wamp_version=g[2];b._server=g[3];if(ab._debugrpc||ab._debugpubsub){console.group("WAMP Welcome");console.info(b._wsuri+"  ["+b._session_id+"]");console.log(b._wamp_version);console.log(b._server);console.groupEnd()}if(b._websocket_onopen!==null){b._websocket_onopen()}}else{throw"protocol error (welcome message received more than once)"}}}}};b._websocket.onopen=function(f){if(b._websocket.protocol!==ab._subprotocol){if(typeof b._websocket.protocol==="undefined"){if(ab._debugws){console.group("WS Warning");console.info(b._wsuri);console.log("WebSocket object has no protocol attribute: WAMP subprotocol check skipped!");console.groupEnd()}}else{if(b._options&&b._options.skipSubprotocolCheck){if(ab._debugws){console.group("WS Warning");console.info(b._wsuri);console.log("Server does not speak WAMP, but subprotocol check disabled by option!");console.log(b._websocket.protocol);console.groupEnd()}}else{b._websocket.close(1000,"server does not speak WAMP");throw"server does not speak WAMP (but '"+b._websocket.protocol+"' !)"}}}if(ab._debugws){console.group("WAMP Connect");console.info(b._wsuri);console.log(b._websocket.protocol);console.groupEnd()}b._websocket_connected=true};b._websocket.onerror=function(f){};b._websocket.onclose=function(f){if(ab._debugws){if(b._websocket_connected){console.log("Autobahn connection to "+b._wsuri+" lost (code "+f.code+", reason '"+f.reason+"', wasClean "+f.wasClean+").")}else{console.log("Autobahn could not connect to "+b._wsuri+" (code "+f.code+", reason '"+f.reason+"', wasClean "+f.wasClean+").")}}if(b._websocket_onclose!==undefined){if(b._websocket_connected){if(f.wasClean){b._websocket_onclose(ab.CONNECTION_CLOSED,"WS-"+f.code+": "+f.reason)}else{b._websocket_onclose(ab.CONNECTION_LOST)}}else{b._websocket_onclose(ab.CONNECTION_UNREACHABLE)}}b._websocket_connected=false;b._wsuri=null;b._websocket_onopen=null;b._websocket_onclose=null;b._websocket=null}};ab.Session.prototype._send=function(c){var a=this;if(!a._websocket_connected){throw"Autobahn not connected"}var b;switch(true){case window.Prototype&&typeof top.window.__prototype_deleted==="undefined":case typeof c.toJSON==="function":b=c.toJSON();break;default:b=JSON.stringify(c)}a._websocket.send(b);a._txcnt+=1;if(ab._debugws){console.group("WS Send");console.info(a._wsuri+"  ["+a._session_id+"]");console.log(a._txcnt);console.log(b);console.groupEnd()}};ab.Session.prototype.close=function(){var a=this;if(a._websocket_connected){a._websocket.close()}else{}};ab.Session.prototype.sessionid=function(){var a=this;return a._session_id};ab.Session.prototype.wsuri=function(){var a=this;return a._wsuri};ab.Session.prototype.log=function(){var a=this;if(a._options.sessionIdent){console.group("WAMP session '"+a._options.sessionIdent+"' ["+a._session_id+"]")}else{console.group("WAMP session ["+a._session_id+"]")}for(var b=0;b<arguments.length;++b){console.log(arguments[b])}console.groupEnd()};ab.Session.prototype.shrink=function(c,b){var a=this;if(b===undefined){b=true}return a._prefixes.shrink(c,b)};ab.Session.prototype.resolve=function(b,c){var a=this;if(c===undefined){c=true}return a._prefixes.resolve(b,c)};ab.Session.prototype.prefix=function(c,b){var a=this;a._prefixes.set(c,b);if(ab._debugrpc||ab._debugpubsub){console.group("WAMP Prefix");console.info(a._wsuri+"  ["+a._session_id+"]");console.log(c);console.log(b);console.groupEnd()}var d=[ab._MESSAGE_TYPEID_PREFIX,c,b];a._send(d)};ab.Session.prototype.call=function(){var a=this;var g=new ab.Deferred();var b;while(true){b=ab._newidFast();if(!(b in a._calls)){break}}a._calls[b]=g;var e=a._prefixes.shrink(arguments[0],true);var f=[ab._MESSAGE_TYPEID_CALL,b,e];for(var c=1;c<arguments.length;c+=1){f.push(arguments[c])}a._send(f);if(ab._debugrpc){g._ab_callobj=f;g._ab_tid=a._wsuri+"  ["+a._session_id+"]["+b+"]";console.time(g._ab_tid);console.info()}if(g.promise.then){return g.promise}else{return g}};ab.Session.prototype.subscribe=function(d,f){var a=this;var b=a._prefixes.resolve(d,true);if(!(b in a._subscriptions)){if(ab._debugpubsub){console.group("WAMP Subscribe");console.info(a._wsuri+"  ["+a._session_id+"]");console.log(d);console.log(f);console.groupEnd()}var e=[ab._MESSAGE_TYPEID_SUBSCRIBE,d];a._send(e);a._subscriptions[b]=[]}var c=a._subscriptions[b].indexOf(f);if(c===-1){a._subscriptions[b].push(f)}else{throw"callback "+f+" already subscribed for topic "+b}};ab.Session.prototype.unsubscribe=function(d,g){var b=this;var c=b._prefixes.resolve(d,true);if(!(c in b._subscriptions)){throw"not subscribed to topic "+c}else{var e;if(g!==undefined){var a=b._subscriptions[c].indexOf(g);if(a!==-1){e=g;b._subscriptions[c].splice(a,1)}else{throw"no callback "+g+" subscribed on topic "+c}}else{e=b._subscriptions[c].slice();b._subscriptions[c]=[]}if(b._subscriptions[c].length===0){delete b._subscriptions[c];if(ab._debugpubsub){console.group("WAMP Unsubscribe");console.info(b._wsuri+"  ["+b._session_id+"]");console.log(d);console.log(e);console.groupEnd()}var f=[ab._MESSAGE_TYPEID_UNSUBSCRIBE,d];b._send(f)}}};ab.Session.prototype.publish=function(){var b=this;var d=arguments[0];var e=arguments[1];var g=null;var a=null;var c=null;var f=null;if(arguments.length>3){if(!(arguments[2] instanceof Array)){throw"invalid argument type(s)"}if(!(arguments[3] instanceof Array)){throw"invalid argument type(s)"}a=arguments[2];c=arguments[3];f=[ab._MESSAGE_TYPEID_PUBLISH,d,e,a,c]}else{if(arguments.length>2){if(typeof(arguments[2])==="boolean"){g=arguments[2];f=[ab._MESSAGE_TYPEID_PUBLISH,d,e,g]}else{if(arguments[2] instanceof Array){a=arguments[2];f=[ab._MESSAGE_TYPEID_PUBLISH,d,e,a]}else{throw"invalid argument type(s)"}}}else{f=[ab._MESSAGE_TYPEID_PUBLISH,d,e]}}if(ab._debugpubsub){console.group("WAMP Publish");console.info(b._wsuri+"  ["+b._session_id+"]");console.log(d);console.log(e);if(g!==null){console.log(g)}else{if(a!==null){console.log(a);if(c!==null){console.log(c)}}}console.groupEnd()}b._send(f)};ab.Session.prototype.authreq=function(b,a){return this.call("http://api.wamp.ws/procedure#authreq",b,a)};ab.Session.prototype.authsign=function(b,a){if(!a){a=""}return CryptoJS.HmacSHA256(b,a).toString(CryptoJS.enc.Base64)};ab.Session.prototype.auth=function(a){return this.call("http://api.wamp.ws/procedure#auth",a)};ab._connect=function(b){var a=new ab.Session(b.wsuri,function(){b.connects+=1;b.retryCount=0;b.onConnect(a)},function(d,e){switch(d){case ab.CONNECTION_CLOSED:b.onHangup(d,"Connection was closed properly ["+e+"]");break;case ab.CONNECTION_UNSUPPORTED:b.onHangup(d,"Browser does not support WebSocket.");break;case ab.CONNECTION_UNREACHABLE:b.retryCount+=1;if(b.connects==0){b.onHangup(d,"Connection could not be established.")}else{if(b.retryCount<=b.options.maxRetries){var c=b.onHangup(ab.CONNECTION_UNREACHABLE_SCHEDULED_RECONNECT,"Connection unreachable - scheduled reconnect to occur in "+(b.options.retryDelay/1000)+" second(s).",{delay:b.options.retryDelay,retries:b.retryCount,maxretries:b.options.maxRetries});if(!c){if(ab._debugconnect){console.log("Connection unreachable - retrying ("+b.retryCount+") ..")}window.setTimeout(ab._connect,b.options.retryDelay,b)}else{if(ab._debugconnect){console.log("Connection unreachable - retrying stopped by app")}b.onHangup(ab.CONNECTION_RETRIES_EXCEEDED,"Number of connection retries exceeded.")}}else{b.onHangup(ab.CONNECTION_RETRIES_EXCEEDED,"Number of connection retries exceeded.")}}break;case ab.CONNECTION_LOST:b.retryCount+=1;if(b.retryCount<=b.options.maxRetries){var c=b.onHangup(ab.CONNECTION_LOST_SCHEDULED_RECONNECT,"Connection lost - scheduled reconnect to occur in "+(b.options.retryDelay/1000)+" second(s).",{delay:b.options.retryDelay,retries:b.retryCount,maxretries:b.options.maxRetries});if(!c){if(ab._debugconnect){console.log("Connection lost - retrying ("+b.retryCount+") ..")}window.setTimeout(ab._connect,b.options.retryDelay,b)}else{if(ab._debugconnect){console.log("Connection lost - retrying stopped by app")}b.onHangup(ab.CONNECTION_RETRIES_EXCEEDED,"Connection lost.")}}else{b.onHangup(ab.CONNECTION_RETRIES_EXCEEDED,"Connection lost.")}break;default:throw"unhandled close code in ab._connect";break}},b.options)};ab.connect=function(a,d,c,b){var e={};e.wsuri=a;if(!b){e.options={}}else{e.options=b}if(e.options.retryDelay==undefined){e.options.retryDelay=5000}if(e.options.maxRetries==undefined){e.options.maxRetries=10}if(e.options.skipSubprotocolCheck==undefined){e.options.skipSubprotocolCheck=false}if(e.options.skipSubprotocolAnnounce==undefined){e.options.skipSubprotocolAnnounce=false}if(!d){throw"onConnect handler required!"}else{e.onConnect=d}if(!c){e.onHangup=function(g,h,f){if(ab._debugconnect){console.log(g,h,f)}}}else{e.onHangup=c}e.connects=0;e.retryCount=0;ab._connect(e)};